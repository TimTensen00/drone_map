<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Drone Map – Basemap + No-fly Zones + Data</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Mapbox CSS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css" rel="stylesheet" />

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
    }
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }

    /* Control panel */
    .panel {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.95);
      padding: 8px 10px;
      border-radius: 6px;
      font-size: 14px;
      z-index: 2;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      width: 180px;
    }
    .panel label {
      display: block;
      margin-bottom: 4px;
    }
    .panel select,
    .panel input[type="range"] {
      width: 100%;
    }
    /* Legend box */
    .legend {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(255,255,255,0.95);
      padding: 8px 10px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      font-size: 13px;
      z-index: 2;
      line-height: 1.4;
      width: 160px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
    }
    
    .legend-swatch {
      width: 20px;
      height: 12px;
      margin-right: 8px;
      border-radius: 2px;
      border: 1px solid #777;
    }
    
    .legend-line {
      width: 22px;
      height: 0;
      margin-right: 8px;
      border-top: 3px solid #fc2ddd; /* Drone line color */
}

  </style>
</head>
<body>

<div id="map"></div>

<!-- Basemap + Date Filter Panel -->
<div class="panel">
  <label for="basemap-select">Verander achtergrondkaart</label>
  <select id="basemap-select">
    <option value="mapbox://styles/mapbox/streets-v12">Streets</option>
    <option value="mapbox://styles/mapbox/light-v11">Light</option>
    <option value="mapbox://styles/mapbox/dark-v11" selected>Dark</option>
    <option value="mapbox://styles/mapbox/satellite-v9">Satellite</option>
  </select>

  <div style="margin-top:10px;">
    <label>Filter op datum:</label>

    <div style="font-size:12px;">Van: <span id="date-min-label">–</span></div>
    <input type="range" id="date-min-slider" min="0" max="0" value="0" step="1" />

    <div style="font-size:12px; margin-top:6px;">Tot: <span id="date-max-label">–</span></div>
    <input type="range" id="date-max-slider" min="0" max="0" value="0" step="1" />
  </div>
</div>

<!-- LEGEND -->
<div class="legend">
  <div class="legend-item">
    <div class="legend-swatch" style="background:#1e90ff; opacity:0.25; border:1px dotted #1e90ff;"></div>
    No-flyzones
  </div>

  <div class="legend-item">
    <div class="legend-line"></div>
    Dronebewegingen
  </div>
</div>


<!-- Mapbox JS -->
<script src="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js"></script>

<script>
  /* --------------------------------------------------
     SETTINGS
  -------------------------------------------------- */

  mapboxgl.accessToken =
    "pk.eyJ1IjoidGltbWFwcGVyIiwiYSI6ImNrcWpjbDBnbzAwbTYyd3IwM2c0NDRlZ3MifQ.VlYKg7MxpFRu3frs1aGhOQ";

  let currentStyle = "mapbox://styles/mapbox/dark-v11";

  const DRONES_GEOJSON_URL = "drones_lines3_wg84.geojson";
  const NOFLY_GEOJSON_URL = "noflyzones.geojson";

  let uniqueDates = [];
  const dateMinSlider = document.getElementById("date-min-slider");
  const dateMaxSlider = document.getElementById("date-max-slider");
  const dateMinLabel = document.getElementById("date-min-label");
  const dateMaxLabel = document.getElementById("date-max-label");

  let droneEventsAdded = false;
  let selectedFeatureId = null;

  /* --------------------------------------------------
     MAP INIT
  -------------------------------------------------- */

  const map = new mapboxgl.Map({
    container: "map",
    style: currentStyle,
    center: [4.300, 52.070],
    zoom: 12
  });

  map.addControl(new mapboxgl.NavigationControl(), "bottom-right");

  /* --------------------------------------------------
     NO-FLY ZONES
  -------------------------------------------------- */

  function addNoFlyLayer() {
    if (!map.getSource("nofly-zones")) {
      map.addSource("nofly-zones", {
        type: "geojson",
        data: NOFLY_GEOJSON_URL
      });
    }

    if (!map.getLayer("nofly-zones-fill")) {
      map.addLayer({
        id: "nofly-zones-fill",
        type: "fill",
        source: "nofly-zones",
        paint: {
          "fill-color": "#1e90ff",
          "fill-opacity": 0.2
        }
      });
    }

    if (!map.getLayer("nofly-zones-outline")) {
      map.addLayer({
        id: "nofly-zones-outline",
        type: "line",
        source: "nofly-zones",
        paint: {
          "line-color": "#1e90ff",
          "line-width": 1,
          "line-dasharray": [2, 2],
          "line-opacity": 0.8
        }
      });
    }
  }

  /* --------------------------------------------------
     DRONE LINES
  -------------------------------------------------- */

  function addDroneLayer() {
    if (!map.getSource("drone-lines")) {
      map.addSource("drone-lines", {
        type: "geojson",
        data: DRONES_GEOJSON_URL,
        generateId: true
      });
    }

    if (!map.getLayer("drone-lines-layer")) {
      map.addLayer({
        id: "drone-lines-layer",
        type: "line",
        source: "drone-lines",
        paint: {
          "line-color": [
            "case",
            ["boolean", ["feature-state", "selected"], false],
            "#ffff00",   // selected = yellow
            "#fc2ddd"    // default = pink
          ],
          "line-width": [
            "case",
            ["boolean", ["feature-state", "selected"], false],
            2,
            1
          ],
          "line-opacity": 0.6
        },
        layout: {
          "line-cap": "round",
          "line-join": "round"
        }
      });
    }

    if (!droneEventsAdded) {
      droneEventsAdded = true;

      map.on("click", "drone-lines-layer", (e) => {
        const feature = e.features[0];
        const p = feature.properties || {};
        const id = feature.id;

        // Reset previous selection
        if (selectedFeatureId !== null) {
          map.setFeatureState(
            { source: "drone-lines", id: selectedFeatureId },
            { selected: false }
          );
        }

        // Set new selection
        if (id !== undefined && id !== null) {
          selectedFeatureId = id;
          map.setFeatureState(
            { source: "drone-lines", id: id },
            { selected: true }
          );
        }

        // Popup HTML
        const html = `
          <div style="font-size:13px; line-height:1.4;">
            <strong>Type drone:</strong> ${p.drone_type || "-"}<br>
            <strong>Gemiddelde hoogte in m.:</strong> ${p.gem_hoogte || "-"}<br>
            <strong>Gebruik:</strong> ${p.type || "-"}<br>
            <strong>Starttijd:</strong> ${formatDateTime(p.tijd_start)}<br>
            <strong>Eindtijd:</strong> ${formatDateTime(p.tijd_end)}<br>
            <strong>tijdsduur in min.:</strong> ${formatDuration(p.tijdsduur_s)}<br>
            <strong>Afstand in m.:</strong> ${p.lengte_m || "-"}
          </div>
        `;

        new mapboxgl.Popup()
          .setLngLat(e.lngLat)
          .setHTML(html)
          .addTo(map);
      });

      map.on("mouseenter", "drone-lines-layer", () => {
        map.getCanvas().style.cursor = "pointer";
      });
      map.on("mouseleave", "drone-lines-layer", () => {
        map.getCanvas().style.cursor = "";
      });
    }
  }

  /* --------------------------------------------------
     DATE FILTER
  -------------------------------------------------- */

  function formatDateTime(value) {
    if (!value) return "-";
    const s = String(value);
    const date = s.slice(0, 10);
    const time = s.length >= 19 ? s.slice(11, 19) : "";
    if (date.length !== 10) return value;
    const y = date.slice(0, 4);
    const m = date.slice(5, 7);
    const d = date.slice(8, 10);
    return `${d}-${m}-${y}${time ? " " + time : ""}`;
  }

  function formatDuration(secondsValue) {
    if (!secondsValue) return "-";
    const total = parseInt(secondsValue, 10);
    if (isNaN(total)) return "-";
    const minutes = Math.floor(total / 60);
    const seconds = total % 60;
    return `${minutes}:${String(seconds).padStart(2, "0")}`;
  }

  function formatDateDisplay(d) {
    if (!d || d.length < 10) return "-";
    return `${d.slice(8, 10)}-${d.slice(5, 7)}-${d.slice(0, 4)}`;
  }

  function prepareDateFilter() {
    fetch(DRONES_GEOJSON_URL)
      .then(r => r.json())
      .then(data => {
        const set = new Set();

        data.features.forEach(f => {
          const val = f.properties.tijd_start;
          if (val) {
            const datePart = String(val).slice(0, 10);
            if (datePart.length === 10) set.add(datePart);
          }
        });

        uniqueDates = Array.from(set).sort();

        if (uniqueDates.length === 0) return;

        dateMinSlider.min = 0;
        dateMinSlider.max = uniqueDates.length - 1;
        dateMaxSlider.min = 0;
        dateMaxSlider.max = uniqueDates.length - 1;

        dateMinSlider.value = 0;
        dateMaxSlider.value = uniqueDates.length - 1;

        dateMinLabel.textContent = formatDateDisplay(uniqueDates[0]);
        dateMaxLabel.textContent = formatDateDisplay(uniqueDates.slice(-1)[0]);

        dateMinSlider.addEventListener("input", updateDateFilter);
        dateMaxSlider.addEventListener("input", updateDateFilter);

        updateDateFilter();
      });
  }

  function updateDateFilter() {
    if (!uniqueDates.length) return;
    if (!map.getLayer("drone-lines-layer")) return;

    let minI = parseInt(dateMinSlider.value);
    let maxI = parseInt(dateMaxSlider.value);

    if (minI > maxI) [minI, maxI] = [maxI, minI];

    const minDate = uniqueDates[minI];
    const maxDate = uniqueDates[maxI];

    dateMinLabel.textContent = formatDateDisplay(minDate);
    dateMaxLabel.textContent = formatDateDisplay(maxDate);

    const filter = [
      "all",
      [">=", ["slice", ["get", "tijd_start"], 0, 10], minDate],
      ["<=", ["slice", ["get", "tijd_start"], 0, 10], maxDate]
    ];

    map.setFilter("drone-lines-layer", filter);
  }

  /* --------------------------------------------------
     LOAD + BASEMAP SWITCH
  -------------------------------------------------- */

  map.on("load", () => {
    addNoFlyLayer();
    addDroneLayer();
    prepareDateFilter();
  });

  const basemapSelect = document.getElementById("basemap-select");
  basemapSelect.value = currentStyle;

  basemapSelect.addEventListener("change", e => {
    currentStyle = e.target.value;
    map.setStyle(currentStyle);

    map.once("style.load", () => {
      droneEventsAdded = false;
      selectedFeatureId = null;
      addNoFlyLayer();
      addDroneLayer();
      updateDateFilter();
    });
  });
</script>

</body>
</html>
