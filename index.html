<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Drone Map â€“ Basemap + No-fly Zones + Data</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Mapbox CSS -->
  <link
    href="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css"
    rel="stylesheet"
  />

  <style>
    /* Fullscreen map */
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
    }
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }

    /* Simple control panel for basemap selector */
    .panel {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.95);
      padding: 8px 10px;
      border-radius: 6px;
      font-size: 14px;
      z-index: 2;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }
    .panel label {
      display: block;
      margin-bottom: 4px;
    }
    .panel select {
      width: 100%;
    }
  </style>
</head>
<body>

  <!-- Map container -->
  <div id="map"></div>

  <!-- Basemap selector UI -->
  <div class="panel">
    <label for="basemap-select">Basemap:</label>
    <select id="basemap-select">
      <option value="mapbox://styles/mapbox/streets-v12">Streets</option>
      <option value="mapbox://styles/mapbox/light-v11">Light</option>
      <option value="mapbox://styles/mapbox/dark-v11">Dark</option>
      <option value="mapbox://styles/mapbox/satellite-v9">Satellite</option>
    </select>
  
    <!-- Date range filter on tijd_start -->
    <div style="margin-top:8px;">
      <label>Datum (tijd_start):</label>
      <div style="font-size:12px; margin-bottom:2px;">
        Van: <span id="date-min-label">â€“</span>
      </div>
      <input
        type="range"
        id="date-min-slider"
        min="0"
        max="0"
        step="1"
        value="0"
      />
  
      <div style="font-size:12px; margin:6px 0 2px;">
        Tot: <span id="date-max-label">â€“</span>
      </div>
      <input
        type="range"
        id="date-max-slider"
        min="0"
        max="0"
        step="1"
        value="0"
      />
    </div>
  </div>


  <!-- Mapbox JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js"></script>

<script>
  // ðŸ”‘ Mapbox public token
  mapboxgl.accessToken = "pk.eyJ1IjoidGltbWFwcGVyIiwiYSI6ImNrcWpjbDBnbzAwbTYyd3IwM2c0NDRlZ3MifQ.VlYKg7MxpFRu3frs1aGhOQ";

  // ðŸŒ Default basemap style
  let currentStyle = "mapbox://styles/mapbox/dark-v11";

  // ðŸ“ GeoJSON filenames (same folder as index.html)
  const DRONES_GEOJSON_URL = "drones_lines3_wg84.geojson";
  const NOFLY_GEOJSON_URL  = "noflyzones.geojson";

  // ðŸ“… Date filter state for tijd_start
  let uniqueDates = []; // array of "YYYY-MM-DD"
  const dateMinSlider = document.getElementById("date-min-slider");
  const dateMaxSlider = document.getElementById("date-max-slider");
  const dateMinLabel  = document.getElementById("date-min-label");
  const dateMaxLabel  = document.getElementById("date-max-label");

  // Flag so we don't attach click handlers multiple times
  let droneEventsAdded = false;

  // ðŸ—ºï¸ Create the map, centered on The Hague
  const map = new mapboxgl.Map({
    container: "map",
    style: currentStyle,
    center: [4.300, 52.070], // [lng, lat] â€“ The Hague
    zoom: 12
  });

  // âž• Zoom / rotation controls
  map.addControl(new mapboxgl.NavigationControl(), "bottom-right");


  /* ----------------------------------------------------
     No-fly zones layer (background)
     ---------------------------------------------------- */
/* ----------------------------------------------------
   No-fly zones layer (background)
   ---------------------------------------------------- */
  function addNoFlyLayer() {
    // Source for no-fly polygons
    if (!map.getSource("nofly-zones")) {
      map.addSource("nofly-zones", {
        type: "geojson",
        data: NOFLY_GEOJSON_URL
      });
    }
  
    // Filled polygon (blue, 0.2 opacity)
    if (!map.getLayer("nofly-zones-fill")) {
      map.addLayer({
        id: "nofly-zones-fill",
        type: "fill",
        source: "nofly-zones",
        paint: {
          "fill-color": "#1e90ff",
          "fill-opacity": 0.2
        }
      });
    }
  
    // Dotted outline (blue, 1px)
    if (!map.getLayer("nofly-zones-outline")) {
      map.addLayer({
        id: "nofly-zones-outline",
        type: "line",
        source: "nofly-zones",
        paint: {
          "line-color": "#1e90ff",
          "line-width": 1,
          "line-dasharray": [2, 2],
          "line-opacity": 0.8
        }
      });
    }
  }


  /* ----------------------------------------------------
     Drone lines layer (foreground)
     ---------------------------------------------------- */
/* ----------------------------------------------------
   Drone lines layer (foreground)
   ---------------------------------------------------- */
  function addDroneLayer() {
    // Source for drone lines
    if (!map.getSource("drone-lines")) {
      map.addSource("drone-lines", {
        type: "geojson",
        data: DRONES_GEOJSON_URL
      });
    }
  
    // Lines on top of no-fly layers
    if (!map.getLayer("drone-lines-layer")) {
      map.addLayer({
        id: "drone-lines-layer",
        type: "line",
        source: "drone-lines",
        paint: {
          "line-color": "#fc2ddd",  // your pink
          "line-width": 1,
          "line-opacity": 0.3       // overlapping strokes naturally look brighter
        },
        layout: {
          "line-cap": "round",
          "line-join": "round"
        }
      });
    }
  
    // Add popup + hover only once
    if (!droneEventsAdded) {
      droneEventsAdded = true;
  
      map.on("click", "drone-lines-layer", (e) => {
        const p = e.features[0].properties || {};
  
        const html = `
          <div style="font-size:13px; line-height:1.4;">
            <strong>Type drone:</strong> ${p.drone_type || "-"}<br>
            <strong>Gemiddelde hoogte:</strong> ${p.gem_hoogte || "-"}<br>
            <strong>Gebruik:</strong> ${p.type || "-"}<br>
            <strong>tijdsduur in sec.:</strong> ${p.tijdsduur_s || "-"}<br>
            <strong>afstand in m.:</strong> ${p.lengte_m || "-"}
          </div>
        `;
  
        new mapboxgl.Popup()
          .setLngLat(e.lngLat)
          .setHTML(html)
          .addTo(map);
      });
  
      map.on("mouseenter", "drone-lines-layer", () => {
        map.getCanvas().style.cursor = "pointer";
      });
      map.on("mouseleave", "drone-lines-layer", () => {
        map.getCanvas().style.cursor = "";
      });
    }
  }
  

  /* ----------------------------------------------------
     Initial load: add both layers + prepare date filter
     ---------------------------------------------------- */
  map.on("load", () => {
    addNoFlyLayer();      // background
    addDroneLayer();      // foreground
    prepareDateFilter();  // build tijd_start date range + apply initial filter
  });


  /* ----------------------------------------------------
     Basemap selector â€“ keep layers + filter after style change
     ---------------------------------------------------- */
  const basemapSelect = document.getElementById("basemap-select");

  basemapSelect.addEventListener("change", (event) => {
    const newStyle = event.target.value;
    currentStyle = newStyle;

    // Change style
    map.setStyle(currentStyle);

    // After style reload, re-add layers and re-apply filter
    map.once("style.load", () => {
      addNoFlyLayer();
      addDroneLayer();
      updateDateFilter(); // re-apply date filter to new style
      console.log("Basemap switched to:", currentStyle);
    });
  });


  /* ----------------------------------------------------
     Date range filter on tijd_start (by day)
     ---------------------------------------------------- */

  // Format "YYYY-MM-DD" -> "dd-mm-yyyy"
  function formatDateDisplay(isoDateStr) {
    if (!isoDateStr || isoDateStr.length < 10) return "-";
    const y = isoDateStr.slice(0, 4);
    const m = isoDateStr.slice(5, 7);
    const d = isoDateStr.slice(8, 10);
    return `${d}-${m}-${y}`;
  }

  // Build the date list and init sliders
  function prepareDateFilter() {
    fetch(DRONES_GEOJSON_URL)
      .then(resp => resp.json())
      .then(data => {
        const dateSet = new Set();

        (data.features || []).forEach(f => {
          const p = f.properties || {};
          if (p.tijd_start) {
            // Take only the date part (assumes "YYYY-MM-DD..." format)
            const datePart = String(p.tijd_start).slice(0, 10);
            if (datePart.length === 10) {
              dateSet.add(datePart);
            }
          }
        });

        uniqueDates = Array.from(dateSet).sort(); // chronological

        if (uniqueDates.length === 0) {
          // No valid dates -> disable sliders
          dateMinSlider.disabled = true;
          dateMaxSlider.disabled = true;
          dateMinLabel.textContent = "geen data";
          dateMaxLabel.textContent = "geen data";
          return;
        }

        // Slider range = indices in uniqueDates[]
        dateMinSlider.min = 0;
        dateMinSlider.max = uniqueDates.length - 1;
        dateMaxSlider.min = 0;
        dateMaxSlider.max = uniqueDates.length - 1;

        // Default range: full span
        dateMinSlider.value = 0;
        dateMaxSlider.value = uniqueDates.length - 1;

        // Labels
        dateMinLabel.textContent = formatDateDisplay(uniqueDates[0]);
        dateMaxLabel.textContent = formatDateDisplay(
          uniqueDates[uniqueDates.length - 1]
        );

        // React to slider changes
        dateMinSlider.addEventListener("input", updateDateFilter);
        dateMaxSlider.addEventListener("input", updateDateFilter);

        // Apply initial filter
        updateDateFilter();
      })
      .catch(err => {
        console.error("Error building date filter:", err);
        // If it fails, we just show all data
      });
  }

  function updateDateFilter() {
    if (!uniqueDates.length) return;
    if (!map.getLayer("drone-lines-layer")) return;

    // Slider positions -> indices -> date strings
    let minIndex = parseInt(dateMinSlider.value, 10);
    let maxIndex = parseInt(dateMaxSlider.value, 10);

    // Ensure min <= max
    if (minIndex > maxIndex) {
      const tmp = minIndex;
      minIndex = maxIndex;
      maxIndex = tmp;
    }

    const minDate = uniqueDates[minIndex];
    const maxDate = uniqueDates[maxIndex];

    // Update labels in dd-mm-yyyy
    dateMinLabel.textContent = formatDateDisplay(minDate);
    dateMaxLabel.textContent = formatDateDisplay(maxDate);

    // Mapbox filter: tijd_start date between minDate and maxDate (inclusive)
    // We compare first 10 chars "YYYY-MM-DD" as strings (works chronologically)
    const filter = [
      "all",
      [">=", ["slice", ["get", "tijd_start"], 0, 10], minDate],
      ["<=", ["slice", ["get", "tijd_start"], 0, 10], maxDate]
    ];

    map.setFilter("drone-lines-layer", filter);
  }
</script>

</body>
</html>
